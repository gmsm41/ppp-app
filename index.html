<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ”ãƒ³ãƒãƒ³ãƒ‘ãƒ³ãƒ“ã‚¸ãƒ§ãƒ³</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
html {
  font-size: 18px;       /* ã‚¹ãƒãƒ›ã®åŸºæœ¬ã‚µã‚¤ã‚ºï¼ˆå°‘ã—å¤§ãã‚ï¼‰ */
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Šã§å°‘ã—å¤§ãã */
@media (min-width: 768px) {
  html {
    font-size: 20px;
  }
}

/* PC ã§ã¯ä»Šã¾ã§é€šã‚Šãã‚‰ã„ã®å¤§ãã• */
@media (min-width: 1024px) {
  html {
    font-size: 22px;
  }
}
    :root {
      --bg1: #1a2a6c;
      --bg2: #fdbb2d;
      --bg3: #ff5f6d;
      --card-bg: rgba(255, 255, 255, 0.9);
      --accent: #ff7a00;
      --accent2: #28b487;
      --danger: #ff3366;
      --neutral: #999;
      --text-main: #222;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top left, var(--bg3), var(--bg2), var(--bg1));
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
    }

    .app {
      width: 100%;
      max-width: 1000px;
      background: linear-gradient(135deg, rgba(255,255,255,.96), rgba(255,255,255,.88));
      border-radius: 20px;
      box-shadow: 0 18px 45px rgba(0,0,0,.25);
      padding: 16px 14px 20px;
      position: relative;
      overflow: hidden;
    }

    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-main {
      font-size: 1.3rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      background: linear-gradient(90deg, var(--bg1), var(--bg3));
      -webkit-background-clip: text;
      color: transparent;
      text-shadow: 0 0 8px rgba(0,0,0,.1);
    }

.title-main .subtitle {
  font-size: 0.9em;  /* â† ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼ */
  margin-left: 0.25em;
}
    .title-sub {
      font-size: 0.6rem;
      color: #666;
    }

    .chip {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.6);
      border: 1px solid rgba(0,0,0,.06);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .nav-pills {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

.pill {
  border-radius: 999px;
  padding: 8px 14px;      /* å°‘ã—å¤§ãã‚ */
  min-height: 38px;       /* æŒ‡ã§æŠ¼ã—ã‚„ã™ã„é«˜ã• */
  border: none;
  font-size: 0.9rem !important;
  background: rgba(0,0,0,.04);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  transition: all .15s ease;
}

.btn {
  border-radius: 999px;
  border: none;
  padding: 10px 18px;     /* ä½™ç™½ã‚’å¢—ã‚„ã™ */
  min-height: 44px;       /* ã‚¹ãƒãƒ›æ¨å¥¨ã‚µã‚¤ã‚º */
  font-size: 1rem !important;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,.18);
  white-space: nowrap;
}

.btn-small {
  padding: 7px 12px;
  min-height: 36px;
  font-size: 0.8rem;
  box-shadow: none;
}
    .pill span.icon {
      font-size: 0.85rem;
    }

    .pill.active {
      background: var(--accent);
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }

    main {
      margin-top: 4px;
    }

    .view {
      display: none;
      animation: fadeIn .2s ease-out;
    }
    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(4px);}
      to {opacity: 1; transform: translateY(0);}
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 14px 12px;
      margin-bottom: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at top right, rgba(255,122,0,.10), transparent 60%);
      opacity: .8;
      pointer-events: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);
      color: #555;
    }

    .card-body {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    label {
      font-size: 0.8rem;
      font-weight: 600;
      display: block;
      margin-bottom: 2px;
    }

    .field-group {
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.18);
      font-size: 0.85rem;
      outline: none;
      background: rgba(255,255,255,0.95);
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255,122,0,.45);
    }

    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #ff9c33);
      color: white;
    }

    .btn-ghost {
      background: rgba(0,0,0,.04);
      color: #444;
      box-shadow: none;
      border: 1px solid rgba(0,0,0,.08);
    }

    .hint {
      font-size: 0.7rem;
      color: #777;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.7rem;
      background: rgba(0,0,0,.06);
      color: #555;
      gap: 4px;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .status {
      font-size: 0.8rem;
      color: #444;
    }

    .status-strong {
      font-weight: 700;
    }

    .pt-summary {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .pt-summary span {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .pt-money {
      font-size: 1.4rem;
      font-weight: 800;
      margin-top: 2px;
    }

    .pt-money.plus {
      color: var(--accent2);
      text-shadow: 0 0 10px rgba(40,180,135,.4);
    }

    .pt-money.minus {
      color: var(--danger);
      text-shadow: 0 0 10px rgba(255,51,102,.35);
    }

    .pt-money.zero {
      color: var(--neutral);
    }

    .fun-label {
      font-size: 0.8rem;
      margin-top: 2px;
      color: #555;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 480px;
      font-size: 0.78rem;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid rgba(0,0,0,.08);
      padding: 4px 6px;
      text-align: center;
    }

    th {
      background: rgba(0,0,0,.04);
      font-weight: 600;
    }

    tr:nth-child(even) td {
      background: rgba(0,0,0,.02);
    }

    .col-highlight {
      background: rgba(40,180,135,0.10) !important;
      font-weight: 700;
    }

    .text-left { text-align: left; }
    .text-right { text-align: right; }

    .msg-large {
      font-size: 1.1rem;
      font-weight: 800;
      text-align: center;
      padding: 20px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.9);
      border: 2px dashed rgba(0,0,0,.08);
      color: #444;
      margin-top: 4px;
    }

    .msg-large span {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: 4px;
      color: #777;
    }

    .tag-plus {
      color: var(--accent2);
      font-weight: 700;
    }
    .tag-minus {
      color: var(--danger);
      font-weight: 700;
    }
    .tag-zero {
      color: var(--neutral);
      font-weight: 700;
    }

    .pill-current {
      background: rgba(40,180,135,0.15);
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.7rem;
      font-weight: 600;
      color: #246a54;
    }

    .small-note {
      font-size: 0.7rem;
      color: #777;
      margin-top: -2px;
    }

    @media (min-width: 768px) {
      .card-grid-2 {
        display: grid;
        grid-template-columns: 1.05fr 1fr;
        gap: 8px;
      }
    }
/* ã‚¹ã‚³ã‚¢ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¹ãƒãƒ›å‘ã‘ï¼‰ */
.table-container-score {
  overflow-x: auto;
}

.score-table {
  width: 100%;
  border-collapse: collapse;
}

.score-table th,
.score-table td {
  padding: 8px 6px;
  font-size: 0.9rem;
  text-align: center;
  white-space: nowrap;
}

.score-table td.name-cell {
  text-align: left;
  font-weight: 600;
}

.score-table tr.row-highlight {
  background: rgba(255, 153, 0, 0.12);
}
@media (max-width: 600px) {
  header.app-header {
    flex-direction: column;
    align-items: flex-start;
  }

  header.app-header > div:last-child {
    align-items: flex-start;
    width: 100%;
  }

  .nav-pills {
    width: 100%;
    justify-content: flex-start;
    flex-wrap: nowrap;      /* æŠ˜ã‚Šè¿”ã•ãªã„ */
    overflow-x: auto;       /* æ¨ªã«ã‚¹ãƒ©ã‚¤ãƒ‰ã§ãã‚‹ã‚ˆã†ã« */
    padding-bottom: 4px;
    gap: 4px;
  }

  .pill {
    white-space: nowrap;
  }
}
.ranking-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed; /* å›ºå®šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§è©°ã‚ã‚‹ */
  min-width: 0;
}

.ranking-table th,
.ranking-table td {
  padding: 3px 4px;
  font-size: 0.7rem;
}

.ranking-table th:nth-child(1),
.ranking-table td:nth-child(1) {
  width: 2.5em;   /* é †ä½ */
}

.ranking-table th:nth-child(3),
.ranking-table td:nth-child(3) {
  width: 4em;    /* pt */
}

.ranking-table th:nth-child(4),
.ranking-table td:nth-child(4) {
  width: 7em;    /* é‡‘é¡ */
}

.ranking-table td.text-left {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;   /* åå‰ãŒé•·ã„ã¨ãã¯ã€Œâ€¦ã€ã§åˆ‡ã‚‹ */
}
.vs-badge-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 4px;
}

.vs-badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 6px;
  border-radius: 999px;
  font-size: 0.72rem;
  background: rgba(0,0,0,0.04);
  gap: 3px;
}

.vs-badge-label {
  font-weight: 600;
}

.vs-badge.pt-plus {
  color: var(--accent2);
}

.vs-badge.pt-minus {
  color: var(--danger);
}

.vs-badge.pt-zero {
  color: var(--neutral);
}
#adminTools {
  background: #ffd7e0;                 /* æ˜ã‚‹ã„ã‚¯ãƒªãƒ¼ãƒ è‰² */
  border: 1px solid #ffb74d;
  box-shadow: 0 8px 20px rgba(0,0,0,.25);
}

#adminTools h3 {
  margin-top: 0;
  font-size: 0.85rem;
}
#btnRenamePlayer {
  border-color: var(--accent2);
  color: #246a54;
  background: #ffffff;
}

#btnDeleteComp {
  border-color: var(--danger);
  color: var(--danger);
  background: #fff0f5;
}
@media (max-width: 480px) {
  .card {
    padding: 12px 10px;
  }

  .ranking-table th,
  .ranking-table td,
  .score-table th,
  .score-table td {
    font-size: 0.65rem;
    padding: 3px 2px;
  }

  .title-main {
    font-size: 1.1rem;
  }

  .title-sub {
    font-size: 0.75rem;
  }
}

  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="title-block">
      <div class="title-main">ãƒ”<span class="subtitle">ãƒ³</span>ãƒ<span class="subtitle">ãƒ³</span>ãƒ‘<span class="subtitle">ãƒ³</span><span class="subtitle">ï½èª‡ã‚Šã‹ã‚‰æ†§ã‚Œã¸ï½</span></div>
      <div class="title-sub">å°å±±YEGã‚´ãƒ«ãƒ•éƒ¨ã€€éå…¬å¼ã‚¢ãƒ—ãƒª</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
      <div class="chip">
        <span>ãƒ¢ãƒ¼ãƒ‰ï¼š</span>
        <span id="chip-mode">ãƒˆãƒƒãƒ—</span>
      </div>
      <div class="nav-pills">
        <button class="pill active" data-view="topView"><span class="icon">ğŸ </span>Top</button>
        <button class="pill" data-view="compView"><span class="icon">ğŸ“…</span>ï½ºï¾ï¾ï¾Ÿ</button>
        <button class="pill" data-view="scoreView"><span class="icon">âœï¸</span>ï½½ï½ºï½±</button>
        <button class="pill" data-view="resultView"><span class="icon">ğŸ†</span>çµæœ</button>
      </div>
    </div>
  </header>

  <main>
    <!-- ãƒˆãƒƒãƒ—ç”»é¢ -->
    <section id="topView" class="view active">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            PPPãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—
            <span class="card-title-tag">ä¾ æ°—ã‚·ã‚¹ãƒ†ãƒ </span>
          </div>
        </div>
        <br>
        <div class="card-body">
          <div class="field-group">
            <label for="menuCompSelect">â˜…ã‚³ãƒ³ãƒšé¸æŠ
            <span class="card-title-tag">ä»Šæ—¥ã¯ä½•ã®ã‚³ãƒ³ãƒšï¼Ÿ</span>
            </label>
            <select id="menuCompSelect"></select>
            <div class="small-note">
              éå»ã®ã‚³ãƒ³ãƒšã‚‚å‡ºã¦ã‚‹ã‹ã‚‰é–“é•ãˆãªã„ã§ï¼
            </div>
          </div>

          <div class="field-group">
            <label for="menuPlayerInput">åå‰é¸æŠ
            <span class="card-title-tag">ä»¥å‰ç™»éŒ²ã—ãŸåå‰ã§å…¥åŠ›ã¾ãŸã¯é¸æŠã—ã¦</span>
            </label>
            <input id="menuPlayerInput" list="playerList" type="text" placeholder="ä¾‹ï¼‰å±±ç”°å¤ªéƒ" />
            <datalist id="playerList"></datalist>
            <div class="hint">ä½•æ–‡å­—ã‹å…¥åŠ›ã™ã‚‹ã¨çµã‚Šè¾¼ã¿ã§ãã‚‹ã€‚è‡ªåˆ†ã®åå‰ãŒãªã„ãªã‚‰å…¥åŠ›ã™ã‚Œã°æ–°è¦ç™»éŒ²ğŸ‘ï¸</div>
          </div>

          <div class="btn-row">
            <button id="btnToScoreFromMenu" class="btn btn-primary">
              <span>ã‚¹ã‚³ã‚¢å…¥åŠ›ã¸</span>
            </button>
            <button id="btnToResultFromMenu" class="btn btn-ghost">
              <span>çµæœç™ºè¡¨ã¸</span>
            </button>
          </div>

          <div class="btn-row">
            <button id="btnToCompFromMenu" class="btn btn-ghost btn-small">
              ğŸ“… æ–°ã—ã„ã‚³ãƒ³ãƒšã‚’ä½œæˆ
            </button>
          </div>

          <div class="status">
            <span class="status-strong">ãƒ’ãƒ³ãƒˆï¼š</span>ã‚¹ã‚³ã‚¢å…¥åŠ›ã—ãŸã„ã‚³ãƒ³ãƒšãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€ã¾ãšã‚³ãƒ³ãƒšä½œæˆğŸ’¡
          </div>

          <!-- â†“â†“â†“ ç®¡ç†è€…ç”¨éš ã—ãƒ„ãƒ¼ãƒ«ï¼ˆCtrl+Shift+M ã§è¡¨ç¤ºåˆ‡æ›¿ï¼‰ â†“â†“â†“ -->
          <div id="adminTools" style="display:none;margin-top:10px;padding-top:8px;border-top:1px dashed #ccc;">
            <div class="section-title">ç®¡ç†è€…ãƒ„ãƒ¼ãƒ«</div>
            <!-- å‚åŠ è€…åå¤‰æ›´ -->
            <div style="margin-top:8px; padding-top:6px; border-top:1px solid rgba(0,0,0,.12);">
              <label style="font-size:0.75rem;">
                <input type="checkbox" id="chkShowAllComps">
                ã‚³ãƒ³ãƒšã‚’å…¨ä»¶è¡¨ç¤ºã™ã‚‹ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼çµæœç™ºè¡¨ï¼‰
              </label>
            </div>

            <!-- å‚åŠ è€…åå¤‰æ›´ -->
            <div class="field-group">
              <label>å‚åŠ è€…åã®å¤‰æ›´</label>
              <input type="text" id="renameOld" placeholder="ç¾åœ¨ã®åå‰ï¼ˆä¾‹ï¼‰å±±ç”°å¤ªéƒ" />
              <input type="text" id="renameNew" placeholder="æ–°ã—ã„åå‰ï¼ˆä¾‹ï¼‰å±±ç”°å¤ªéƒï¼ˆå¹¹äº‹ï¼‰" style="margin-top:4px;" />
              <button class="btn btn-ghost btn-small" id="btnRenamePlayer" style="margin-top:4px;">
                å‚åŠ è€…åã‚’å¤‰æ›´
              </button>
              <div class="hint">
                â€»åŒã˜åå‰ãŒæ—¢ã«ã‚ã‚‹å ´åˆã¯å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚ï¼ˆç™»éŒ²æ¸ˆã¿ã‚¹ã‚³ã‚¢ã¯ã™ã¹ã¦æ–°ã—ã„åå‰ã§è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
              </div>
            </div>

            <!-- ã‚³ãƒ³ãƒšå‰Šé™¤ -->
            <div class="field-group" style="margin-top:8px;">
              <label>ã‚³ãƒ³ãƒšå‰Šé™¤ï¼ˆç¾åœ¨é¸æŠä¸­ï¼‰</label>
              <button class="btn btn-ghost btn-small" id="btnDeleteComp">
                âš  ã“ã®ã‚³ãƒ³ãƒšã‚’å‰Šé™¤<br>ï¼ˆã‚¹ã‚³ã‚¢ã‚‚å…¨å‰Šé™¤ï¼‰
              </button>
              <div class="hint">
                â€»2å›ç¢ºèªã®ã†ãˆå‰Šé™¤ã—ã¾ã™ã€‚scores ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
              </div>
            </div>
          </div>
          <!-- â†‘â†‘â†‘ ç®¡ç†è€…ç”¨éš ã—ãƒ„ãƒ¼ãƒ« â†‘â†‘â†‘ -->
        </div>
      </div>
    </section>

    <!-- ã‚³ãƒ³ãƒšä½œæˆç”»é¢ -->
    <section id="compView" class="view">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            ã‚³ãƒ³ãƒšä½œæˆ
            <span class="card-title-tag">é–‹å‚¬æ—¥ã€åç§°ã€é‡‘é¡ã‚’è¨­å®š</span>
          </div>
          <button class="btn btn-ghost btn-small" data-view="topView">â† Topã¸æˆ»ã‚‹</button>
        </div>
        <div class="card-body">
          <div class="card-grid-2">
            <div>
              <div class="field-group">
                <label for="compDate">é–‹å‚¬æ—¥</label>
                <input id="compDate" type="date" />
                <div class="hint" id="compDateWarekiHint"></div>
              </div>

              <div class="field-group">
                <label for="compName">ã‚³ãƒ³ãƒšåï¼ˆ20æ–‡å­—ã¾ã§ï¼‰</label>
                <input id="compName" type="text" maxlength="20" placeholder="ä¾‹ï¼‰æ˜¥ã®å°å±±YEGæ¯" />
              </div>

              <div class="field-group">
                <label for="compPtValue">æ›ã‘é‡‘ï¼ˆå††ï¼‰</label>
                <input id="compPtValue" type="number" min="0" step="100" value="1000" />
                <div class="hint">ã ã„ãŸã„1000å††</div>
              </div>
            </div>
            <div>
              <div id="compExistingInfo" class="hint"></div>
            </div>
          </div>

          <div class="btn-row">
            <button id="btnSaveComp" class="btn btn-primary">ã‚³ãƒ³ãƒšã‚’ç™»éŒ² / æ›´æ–°</button>
            <button class="btn btn-ghost btn-small" id="btnCompClear">
              å…¥åŠ›ã‚¯ãƒªã‚¢
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- ã‚¹ã‚³ã‚¢å…¥åŠ›ç”»é¢ -->
    <section id="scoreView" class="view">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            ã‚¹ã‚³ã‚¢å…¥åŠ›
            <span class="card-title-tag">IN / OUT / ãƒãƒ³ãƒ‡</span>
          </div>
          <button class="btn btn-ghost btn-small" data-view="topView">â† Topã¸æˆ»ã‚‹</button>
        </div>
        <div class="card-body">
          <div class="field-group">
            <div class="section-title">å¯¾è±¡ã‚³ãƒ³ãƒš</div>
            <div id="scoreCompInfo" class="badge">
              æœªé¸æŠã§ã™ã€‚ä½•ã‚„ã£ã¦ã‚“ã®ğŸ’¢æˆ»ã£ã¦é¸ã‚“ã§ã“ã„ğŸ’¢
            </div>
          </div>

          <div class="field-group">
            <label for="scorePlayerInput">åå‰é¸æŠ
            <span class="card-title-tag">ã‚¤ãƒ³ãƒã‚­ç¦æ­¢</span>
            </label>
            <input id="scorePlayerInput" list="playerList" type="text" placeholder="ä¾‹ï¼‰å±±ç”°å¤ªéƒ" />
            <div class="hint">å…¥åŠ›ã™ã‚‹ã¨å€™è£œã‹ã‚‰çµã‚Šè¾¼ã¿ã€‚æ–°ã—ã„åå‰ã¯ãã®ã¾ã¾ç™»éŒ²ã•ã‚Œã¾ã™ã€‚</div>
          </div>

          <div class="field-group">
            <label for="inScore">IN ã‚¹ã‚³ã‚¢</label>
            <input id="inScore" type="number" min="0" />
          </div>

          <div class="field-group">
            <label for="outScore">OUT ã‚¹ã‚³ã‚¢</label>
            <input id="outScore" type="number" min="0" />
          </div>

          <div class="field-group">
            <label for="handicap">ãƒãƒ³ãƒ‡ï¼ˆæ•´æ•°ãƒ»Â±ã‚ã‚Šï¼‰</label>
            <input id="handicap" type="number" step="2" value="0" />
            <div class="hint">ãƒãƒ³ãƒ‡10 â†’ IN+5 / OUT+5ã€ãƒãƒ³ãƒ‡-10 â†’ IN-5 / OUT-5 ã§è¨ˆç®—ã—ã¾ã™ã€‚</div>
          </div>

          <div class="btn-row">
            <button id="btnSaveScore" class="btn btn-primary">ã‚¹ã‚³ã‚¢ã‚’ç™»éŒ² / æ›´æ–°</button>
            <button id="btnLoadScore" class="btn btn-ghost btn-small">ã“ã®å‚åŠ è€…ã®ã‚¹ã‚³ã‚¢ã‚’èª­ã¿è¾¼ã¿</button>
          </div>
        </div>
      </div>
    </section>

    <!-- çµæœç™ºè¡¨ç”»é¢ -->
    <section id="resultView" class="view">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            çµæœç™ºè¡¨
            <span class="card-title-tag">ãƒ”ãƒ³ãƒãƒ³ãƒ‘ãƒ³æ¡ç‚¹</span>
          </div>
          <button class="btn btn-ghost btn-small" data-view="topView">â† Topã¸æˆ»ã‚‹</button>
        </div>
        <div class="card-body">
          <div class="field-group">
            <label for="resultCompSelect">ã‚³ãƒ³ãƒšé¸æŠ
            <span class="card-title-tag">ã©ã®ã‚³ãƒ³ãƒšã®çµæœã§ã™ã‹ï¼Ÿ</span>
            </label>
            <select id="resultCompSelect"></select>
          </div>

          <div class="field-group">
            <label for="resultPlayerSelect">åå‰é¸æŠ
            <span class="card-title-tag">èª°ã®çµæœã‚’è¦‹ã¾ã™ã‹ï¼Ÿ</span>
            </label>
            <select id="resultPlayerSelect"></select>
            <div class="hint">ã“ã®ã‚³ãƒ³ãƒšã§ã‚¹ã‚³ã‚¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã¨é¸ã¹ãªã„ã‚ˆ</div>
          </div>

          <div id="resultMain"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  // ==========================
  // Supabase åˆæœŸåŒ–
  // ==========================
  const { createClient } = supabase;

  // â˜…ã“ã“ã‚’ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å€¤ã«å·®ã—æ›¿ãˆâ˜…
  const SUPABASE_URL = 'https://eszagvoyihjkrwvurlad.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzemFndm95aWhqa3J3dnVybGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxOTQ0NjIsImV4cCI6MjA3ODc3MDQ2Mn0.LHD3ObTz6hmaEGUFTluOp7y5cv7aMxDpYNr-vO7nYKo';

  const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ==========================
  // æ±ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // ==========================
  function toWarekiShort(dateISO) {
    if (!dateISO) return '';
    const [y, m, d] = dateISO.split('-').map(Number);
    const date = new Date(y, m - 1, d);

    const heiseiStart = new Date(1989, 0, 8);
    const reiwaStart = new Date(2019, 4, 1);

    let era = '';
    let year = y;

    if (date >= reiwaStart) {
      era = 'R';
      year = y - 2018;
    } else if (date >= heiseiStart) {
      era = 'H';
      year = y - 1988;
    } else {
      era = 'S';
      year = y - 1925;
    }

    return `${era}${year}/${m}/${d}`;
  }

  let currentCompId = null;
  let currentPlayerName = '';

// â˜…ã‚³ãƒ³ãƒšè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼šfalse = ç›´è¿‘åŠå¹´ / true = å…¨ä»¶
let showAllCompetitions = false;

  // ==========================
  // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
  // ==========================
  const views = {
    topView: document.getElementById('topView'),
    compView: document.getElementById('compView'),
    scoreView: document.getElementById('scoreView'),
    resultView: document.getElementById('resultView')
  };

  const chipMode = document.getElementById('chip-mode');
// ä¸Šéƒ¨ãƒŠãƒ“ï¼ˆpillï¼‰ç”¨
const pills = document.querySelectorAll('.pill[data-view]');
pills.forEach(p => {
  p.addEventListener('click', () => {
    const targetView = p.dataset.view;

    if (targetView === 'scoreView' || targetView === 'resultView') {
      const compFromMenu = menuCompSelect.value;
      if (compFromMenu) currentCompId = compFromMenu;

      const playerFromMenu = menuPlayerInput.value.trim();
      if (playerFromMenu) {
        currentPlayerName = playerFromMenu;
        scorePlayerInput.value = playerFromMenu;
      }
    }

    showView(targetView);
  });
});

// â˜…è¿½åŠ ï¼špill ä»¥å¤–ã®ã€Œâ† Topã¸æˆ»ã‚‹ã€ãªã©ã«ã‚‚ showView ã‚’ã¤ãªã
document.querySelectorAll('button[data-view]:not(.pill)').forEach(btn => {
  btn.addEventListener('click', () => {
    const targetView = btn.dataset.view;
    showView(targetView);
  });
});

function showView(id) {
  Object.values(views).forEach(v => v.classList.remove('active'));
  views[id].classList.add('active');

  pills.forEach(p => {
    if (p.dataset.view === id) p.classList.add('active');
    else p.classList.remove('active');
  });

  let modeLabel = '';
  switch (id) {
    case 'topView': modeLabel = 'ãƒˆãƒƒãƒ—'; break;
    case 'compView': modeLabel = 'ã‚³ãƒ³ãƒšä½œæˆ'; break;
    case 'scoreView': modeLabel = 'ã‚¹ã‚³ã‚¢å…¥åŠ›'; break;
    case 'resultView': modeLabel = 'çµæœç™ºè¡¨'; break;
  }
  chipMode.textContent = modeLabel;

  if (id === 'topView') {
    refreshMenuCompSelect();
  } else if (id === 'scoreView') {
    updateScoreCompInfo();
    // â˜… ã“ã“ã‚’è¿½åŠ ï¼šåå‰ãŒå…¥ã£ã¦ã„ã‚Œã°è‡ªå‹•èª­ã¿è¾¼ã¿
    if (scorePlayerInput.value.trim()) {
      loadScoreForCurrentPlayer();
    }
  } else if (id === 'resultView') {
    refreshResultCompSelect();
    renderResultMain();
  }
}


  // ==========================
  // ãƒˆãƒƒãƒ—ç”»é¢
  // ==========================
  const menuCompSelect = document.getElementById('menuCompSelect');
  const menuPlayerInput = document.getElementById('menuPlayerInput');
  const playerDatalist = document.getElementById('playerList');

// ç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼ˆå‚åŠ è€…åå¤‰æ›´ï¼‰
const chkShowAllComps = document.getElementById('chkShowAllComps');
if (chkShowAllComps) {
  chkShowAllComps.addEventListener('change', async (e) => {
    showAllCompetitions = e.target.checked;
    await refreshMenuCompSelect();
    await refreshResultCompSelect(); // â† ã“ã‚Œã‚’å¾©æ´»
  });
}
const renameOldInput = document.getElementById('renameOld');
const renameNewInput = document.getElementById('renameNew');
const btnRenamePlayer = document.getElementById('btnRenamePlayer');

const btnDeleteComp = document.getElementById('btnDeleteComp');

  async function fetchPlayers() {
    const { data, error } = await db.from('players').select('*').order('name', { ascending: true });
    if (error) {
      console.error(error);
      return [];
    }
    return data || [];
  }

  async function refreshPlayerDatalist() {
    const players = await fetchPlayers();
    playerDatalist.innerHTML = '';
    players.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.name;
      playerDatalist.appendChild(opt);
    });
  }

async function fetchCompetitionsAll() {
  const { data, error } = await db
    .from('competitions')
    .select('*')
    .order('date', { ascending: false });

  if (error) {
    console.error(error);
    return [];
  }

  const rows = data || [];

  // ã€Œã‚³ãƒ³ãƒšå ï¼‹ æ—¥ä»˜ã€ãŒåŒã˜ã‚‚ã®ã¯1ä»¶ã«ã¾ã¨ã‚ã‚‹
  const seen = new Set();
  const deduped = [];
  for (const c of rows) {
    const key = `${c.name}__${c.date}`;
    if (!seen.has(key)) {
      seen.add(key);
      deduped.push(c);
    }
  }

  return deduped;
}

async function refreshMenuCompSelect() {
  const select = menuCompSelect;

  // ã„ã¾é¸ã°ã‚Œã¦ã„ã‚‹IDï¼ˆã¾ãŸã¯ currentCompIdï¼‰ã‚’è¦šãˆã¦ãŠã
  const prevSelected =
    currentCompId ||
    (select ? select.value : '') ||
    '';

  select.innerHTML = '';
  //select.length = 0;

  const compsSorted = await fetchCompetitionsAll();
//alert("ãƒˆãƒƒãƒ—" + compsSorted.length);
  if (compsSorted.length === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'ã‚³ãƒ³ãƒšãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';
    select.appendChild(opt);
    currentCompId = null;
    return;
  }

  const now = new Date();
  const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
  const filtered = compsSorted.filter(c => new Date(c.date) >= sixMonthsAgo);
  //const compsToShow = filtered.length ? filtered : compsSorted;
  // â˜…ãƒ•ãƒ©ã‚°ã«å¿œã˜ã¦ã€ŒåŠå¹´åˆ†ã€orã€Œå…¨ä»¶ã€
  const compsToShow = showAllCompetitions
    ? compsSorted
    : (filtered.length ? filtered : compsSorted);

  compsToShow.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = `${c.name}ã€€${toWarekiShort(c.date)}`;
    select.appendChild(opt);
  });

  // â‘  ä»¥å‰é¸ã‚“ã§ã„ãŸã‚³ãƒ³ãƒšãŒã‚ã‚Œã°ã€ãã‚Œã‚’å„ªå…ˆ
  let targetId = prevSelected && compsToShow.some(c => c.id === prevSelected)
    ? prevSelected
    : null;

  // â‘¡ ãªã‘ã‚Œã°ã€Œä»Šæ—¥ã®ã‚³ãƒ³ãƒšã€â†’ãªã‘ã‚Œã°æœ€æ–°ã‚³ãƒ³ãƒš
  if (!targetId) {
    const todayISO = new Date().toISOString().slice(0, 10);
    const todayComp = compsToShow.find(c => c.date === todayISO);
    const fallback = todayComp || compsToShow[0];
    targetId = fallback.id;
  }

  select.value = targetId;
  currentCompId = targetId;
//alert('ãƒˆãƒƒãƒ—options:' + [...menuCompSelect.options].map(o => o.textContent));

}

  document.getElementById('btnToScoreFromMenu').addEventListener('click', () => {
    const compId = menuCompSelect.value;
    if (!compId) {
      alert('ã‚³ãƒ³ãƒšã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    currentCompId = compId;
    currentPlayerName = menuPlayerInput.value.trim();
    document.getElementById('scorePlayerInput').value = currentPlayerName;
    showView('scoreView');
  });

  document.getElementById('btnToResultFromMenu').addEventListener('click', () => {
    const compId = menuCompSelect.value;
    if (!compId) {
      alert('ã‚³ãƒ³ãƒšã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    // é¸æŠä¸­ã®ã‚³ãƒ³ãƒšã‚’å…±æœ‰
    currentCompId = compId;
    // ãƒˆãƒƒãƒ—ç”»é¢ã§å…¥åŠ›ä¸­ã®åå‰ã‚’ã€Œãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã™ã‚‹äººã€ã¨ã—ã¦å…±æœ‰
    currentPlayerName = menuPlayerInput.value.trim();
    // çµæœç”»é¢ã®æç”»å´ã§ currentPlayerName ã‚’è¦‹ã¦ãã‚Œã‚‹ã®ã§ã€
    // ã“ã“ã§ã¯ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ç›´æ¥ã„ã˜ã‚‰ãªãã¦OK
    showView('resultView');
  });

  document.getElementById('btnToCompFromMenu').addEventListener('click', () => {
    showView('compView');
  });

  // ==========================
  // ã‚³ãƒ³ãƒšä½œæˆç”»é¢
  // ==========================
  const compDateInput = document.getElementById('compDate');
  const compNameInput = document.getElementById('compName');
  const compPtValueInput = document.getElementById('compPtValue');
  const compDateWarekiHint = document.getElementById('compDateWarekiHint');
  const compExistingInfo = document.getElementById('compExistingInfo');

  compDateInput.addEventListener('change', async () => {
    const dateISO = compDateInput.value;
    if (!dateISO) {
      compDateWarekiHint.textContent = '';
      compExistingInfo.textContent = '';
      return;
    }
    const wareki = toWarekiShort(dateISO);
    compDateWarekiHint.textContent = `å’Œæš¦è¡¨è¨˜ï¼š${wareki}`;

    const { data, error } = await db.from('competitions').select('*').eq('date', dateISO);
    if (error) {
      console.error(error);
      return;
    }
if (data && data.length > 0) {
  const first = data[0];

  // 1ä»¶ç›®ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
  compNameInput.value = first.name;
  compPtValueInput.value = first.pt_value;

  // ãã®æ—¥ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒšä¸€è¦§ã‚’è¡¨ç¤º
  const listHtml = data.map(c =>
    `ãƒ»${c.name}ï¼ˆ${toWarekiShort(c.date)}ï¼1pt=${c.pt_value.toLocaleString()}å††ï¼‰`
  ).join('<br>');

  compExistingInfo.innerHTML = `
    <div>ã“ã®é–‹å‚¬æ—¥ã«ã¯ä»¥ä¸‹ã®ã‚³ãƒ³ãƒšãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚</div>
    <div style="margin:4px 0 6px 0;">${listHtml}</div>
    <div>
      <label style="display:block;font-size:0.8rem;">
        <input type="radio" name="compMode" value="edit" checked>
        ä¸Šã®å†…å®¹ï¼ˆæœ€åˆã®ã‚³ãƒ³ãƒšã€Œ${first.name}ã€ï¼‰ã‚’ä¿®æ­£ã™ã‚‹
      </label>
      <label style="display:block;font-size:0.8rem;margin-top:2px;">
        <input type="radio" name="compMode" value="new">
        åˆ¥ã®ã‚³ãƒ³ãƒšã¨ã—ã¦æ–°è¦ç™»éŒ²ã™ã‚‹
      </label>
    </div>
  `;
} else {
  compExistingInfo.innerHTML = '';
}

  });

  document.getElementById('btnSaveComp').addEventListener('click', async () => {
    const dateISO = compDateInput.value;
    const name = compNameInput.value.trim();
    const ptValue = parseInt(compPtValueInput.value, 10) || 0;

    if (!dateISO) {
      alert('é–‹å‚¬æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    if (!name) {
      alert('ã‚³ãƒ³ãƒšåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    const wareki = toWarekiShort(dateISO);
    const { data: existing, error } = await db.from('competitions').select('*').eq('date', dateISO);
    if (error) {
      console.error(error);
      alert('ã‚³ãƒ³ãƒšæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      return;
    }

if (existing && existing.length > 0) {
  const first = existing[0];

  // compMode ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®é¸æŠã‚’å–å¾—ï¼ˆãªã‘ã‚Œã° edit æ‰±ã„ï¼‰
  let mode = 'edit';
  const radios = document.querySelectorAll('input[name="compMode"]');
  radios.forEach(r => {
    if (r.checked) mode = r.value;
  });

  if (mode === 'edit') {
    const { error: updErr } = await db.from('competitions')
      .update({ name, pt_value: ptValue })
      .eq('id', first.id);
    if (updErr) {
      console.error(updErr);
      alert('ã‚³ãƒ³ãƒšã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      return;
    }
    alert('ã‚³ãƒ³ãƒšå†…å®¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
  } else {
    const { error: insErr } = await db.from('competitions')
      .insert({ name, date: dateISO, pt_value: ptValue });
    if (insErr) {
      console.error(insErr);
      alert('ã‚³ãƒ³ãƒšã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      return;
    }
    alert('ã‚³ãƒ³ãƒšã‚’æ–°è¦ç™»éŒ²ã—ã¾ã—ãŸã€‚');
  }
} else {
  const { error: insErr } = await db.from('competitions')
    .insert({ name, date: dateISO, pt_value: ptValue });
  if (insErr) {
    console.error(insErr);
    alert('ã‚³ãƒ³ãƒšã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    return;
  }
  alert('ã‚³ãƒ³ãƒšã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚');
}

    //refreshMenuCompSelect();
    //refreshResultCompSelect();
    // â˜… ã“ã“ã‚’è¿½åŠ ï¼šç™»éŒ²å¾Œã¯ãƒˆãƒƒãƒ—ã¸
    showView('topView');
  });

  document.getElementById('btnCompClear').addEventListener('click', () => {
    compDateInput.value = '';
    compNameInput.value = '';
    compPtValueInput.value = 1000;
    compDateWarekiHint.textContent = '';
    compExistingInfo.textContent = '';
  });

  // ==========================
  // ã‚¹ã‚³ã‚¢å…¥åŠ›ç”»é¢
  // ==========================
  const scoreCompInfo = document.getElementById('scoreCompInfo');
  const scorePlayerInput = document.getElementById('scorePlayerInput');
  const inScoreInput = document.getElementById('inScore');
  const outScoreInput = document.getElementById('outScore');
  const handicapInput = document.getElementById('handicap');

  async function updateScoreCompInfo() {
    if (!currentCompId) {
      scoreCompInfo.textContent = 'ã‚³ãƒ³ãƒšãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä½•ã‚„ã£ã¦ã‚“ã®ğŸ’¢æˆ»ã£ã¦ã‚³ãƒ³ãƒšã‚’é¸ã‚“ã§ã“ã„ğŸ’¢';
      return;
    }
    const { data: comp, error } = await db.from('competitions').select('*').eq('id', currentCompId).maybeSingle();
    if (error || !comp) {
      scoreCompInfo.textContent = 'ã‚³ãƒ³ãƒšæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
      return;
    }
    scoreCompInfo.innerHTML = `<span class="pill-current">${comp.name}</span>ã€€${toWarekiShort(comp.date)}ã€€1pt = ${comp.pt_value.toLocaleString()} å††`;
  }

  async function getPlayerByName(name) {
    const trimmed = name.trim();
    if (!trimmed) return null;
    const { data, error } = await db.from('players').select('*').eq('name', trimmed).maybeSingle();
    if (error) {
      console.error(error);
      return null;
    }
    return data || null;
  }

  async function getOrCreatePlayerByName(name) {
    const trimmed = name.trim();
    if (!trimmed) return null;
    let player = await getPlayerByName(trimmed);
    if (player) return player;

    const { data, error } = await db.from('players')
      .insert({ name: trimmed })
      .select()
      .single();
    if (error) {
      console.error(error);
      alert('åå‰ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      return null;
    }
    await refreshPlayerDatalist();
    return data;
  }

btnRenamePlayer.addEventListener('click', async () => {
  const oldName = renameOldInput.value.trim();
  const newName = renameNewInput.value.trim();

  if (!oldName || !newName) {
    alert('ç¾åœ¨ã®åå‰ã¨æ–°ã—ã„åå‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  if (oldName === newName) {
    alert('åŒã˜åå‰ã«ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚');
    return;
  }

  // â‘  ç¾åœ¨ã®åå‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å–å¾—
  const { data: oldPlayer, error: oldErr } = await db
    .from('players')
    .select('*')
    .eq('name', oldName)
    .maybeSingle();

  if (oldErr) {
    console.error(oldErr);
    alert('ç¾åœ¨ã®åå‰ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    return;
  }
  if (!oldPlayer) {
    alert(`ã€Œ${oldName}ã€ã¨ã„ã†å‚åŠ è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
    return;
  }

  // â‘¡ æ–°ã—ã„åå‰ãŒæ—¢ã«å­˜åœ¨ã—ãªã„ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆé‡è¤‡ç¦æ­¢ï¼‰
  const { data: dup, error: dupErr } = await db
    .from('players')
    .select('id')
    .eq('name', newName)
    .maybeSingle();

  if (dupErr) {
    console.error(dupErr);
    alert('é‡è¤‡ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    return;
  }
  if (dup) {
    alert(`ã€Œ${newName}ã€ã¨ã„ã†å‚åŠ è€…åã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®åå‰ã«ã—ã¦ãã ã•ã„ã€‚`);
    return;
  }

  // â‘¢ ç¢ºèª
  const ok = confirm(
    `å‚åŠ è€…åã‚’å¤‰æ›´ã—ã¾ã™ã€‚\n\nã€Œ${oldName}ã€ â†’ ã€Œ${newName}ã€\n\n` +
    'ã“ã‚Œã¾ã§ã®ã‚¹ã‚³ã‚¢ã®è¡¨ç¤ºã‚‚ã™ã¹ã¦æ–°ã—ã„åå‰ã«ãªã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
  );
  if (!ok) return;

  // â‘£ players ãƒ†ãƒ¼ãƒ–ãƒ«ã®åå‰ã‚’æ›´æ–°
  const { error: updErr } = await db
    .from('players')
    .update({ name: newName })
    .eq('id', oldPlayer.id);

  if (updErr) {
    console.error(updErr);
    alert('åå‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    return;
  }

  // â‘¤ åå‰å€™è£œãƒªã‚¹ãƒˆã‚„å…¥åŠ›æ¬„ã‚’æ›´æ–°
  await refreshPlayerDatalist();

  if (menuPlayerInput.value.trim() === oldName) menuPlayerInput.value = newName;
  if (scorePlayerInput.value.trim() === oldName) scorePlayerInput.value = newName;
  if (resultPlayerSelect.value.trim() === oldName) resultPlayerSelect.value = newName;

  alert('å‚åŠ è€…åã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚');
});

btnDeleteComp.addEventListener('click', async () => {
  const compId = menuCompSelect.value || currentCompId;

  if (!compId) {
    alert('å‰Šé™¤ã™ã‚‹ã‚³ãƒ³ãƒšãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã‚³ãƒ³ãƒšã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
    return;
  }

  // å¯¾è±¡ã‚³ãƒ³ãƒšã®æƒ…å ±ã‚’å–å¾—
  const { data: comp, error } = await db
    .from('competitions')
    .select('*')
    .eq('id', compId)
    .maybeSingle();

  if (error || !comp) {
    console.error(error);
    alert('ã‚³ãƒ³ãƒšæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    return;
  }

  const compLabel = `${comp.name}ï¼ˆ${toWarekiShort(comp.date)}ï¼‰`;

  // 2æ®µéšç¢ºèª
  const ok1 = confirm(
    `ã€Œ${compLabel}ã€ã‚’å‰Šé™¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚\n\n` +
    'ã“ã®ã‚³ãƒ³ãƒšã«ç´ã¥ãã‚¹ã‚³ã‚¢ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\n' +
    'æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
  );
  if (!ok1) return;

  const ok2 = confirm(
    'ã€æœ€çµ‚ç¢ºèªã€‘\n\n' +
    `ã€Œ${compLabel}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
    'ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚'
  );
  if (!ok2) return;

  // competitions ã‚’å‰Šé™¤ï¼ˆscores ã¯ on delete cascade ã§ä¸€ç·’ã«å‰Šé™¤ã•ã‚Œã‚‹ï¼‰
  const { error: delErr } = await db
    .from('competitions')
    .delete()
    .eq('id', compId);

  if (delErr) {
    console.error(delErr);
    alert('ã‚³ãƒ³ãƒšã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    return;
  }

  alert('ã‚³ãƒ³ãƒšã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ï¼ˆç´ã¥ãã‚¹ã‚³ã‚¢ã‚‚å‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™ï¼‰');

  currentCompId = null;
  await refreshMenuCompSelect();
  await refreshResultCompSelect();
  resultMain.innerHTML = '';
  showView('topView');
});

  async function loadScoreForCurrentPlayer() {
    const name = scorePlayerInput.value.trim();
    if (!name) {
      alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä½•ã‚„ã£ã¦ã‚“ã®ğŸ’¢');
      return;
    }
    if (!currentCompId) {
      alert('ã‚³ãƒ³ãƒšãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä½•ã‚„ã£ã¦ã‚“ã®ğŸ’¢');
      return;
    }
    const player = await getPlayerByName(name);
    if (!player) {
      inScoreInput.value = '';
      outScoreInput.value = '';
      handicapInput.value = '';
      return;
    }
    const { data, error } = await db.from('scores')
      .select('*')
      .eq('competition_id', currentCompId)
      .eq('player_id', player.id)
      .maybeSingle();
    if (error) {
      console.error(error);
      alert('ã‚¹ã‚³ã‚¢ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      return;
    }
    if (!data) {
      inScoreInput.value = '';
      outScoreInput.value = '';
      handicapInput.value = '';
    } else {
      inScoreInput.value = data.in_score;
      outScoreInput.value = data.out_score;
      handicapInput.value = data.handicap;
    }
  }

  document.getElementById('btnLoadScore').addEventListener('click', () => {
    loadScoreForCurrentPlayer();
  });

  document.getElementById('btnSaveScore').addEventListener('click', async () => {
    if (!currentCompId) {
      alert('ã‚³ãƒ³ãƒšãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä½•ã‚„ã£ã¦ã‚“ã®ğŸ’¢');
      return;
    }
    const name = scorePlayerInput.value.trim();
    if (!name) {
      alert('å‚åŠ è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    const inScore = parseInt(inScoreInput.value, 10);
    const outScore = parseInt(outScoreInput.value, 10);
    const handicap = parseInt(handicapInput.value, 10) || 0;

    if (isNaN(inScore) || inScore < 0) {
      alert('INã‚¹ã‚³ã‚¢ã‚’0ä»¥ä¸Šã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã‚ã‹ã‚‹ã§ã—ã‚‡ğŸ’¢');
      return;
    }
    if (isNaN(outScore) || outScore < 0) {
      alert('OUTã‚¹ã‚³ã‚¢ã‚’0ä»¥ä¸Šã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒã‚«ãªã®ğŸ’¢');
      return;
    }
    if (handicap % 2 !== 0) {
      alert('ãƒãƒ³ãƒ‡ã¯å¶æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã‚ã‹ã‚‹ã§ã—ã‚‡ğŸ’¢');
      return;
    }

    const player = await getOrCreatePlayerByName(name);
    if (!player) return;

    const { data: existing, error } = await db.from('scores')
      .select('*')
      .eq('competition_id', currentCompId)
      .eq('player_id', player.id)
      .maybeSingle();
    if (error) {
      console.error(error);
      alert('ã‚¹ã‚³ã‚¢ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      return;
    }

    if (existing) {
      const { error: updErr } = await db.from('scores')
        .update({
          in_score: inScore,
          out_score: outScore,
          handicap,
          updated_at: new Date().toISOString()
        })
        .eq('id', existing.id);
      if (updErr) {
        console.error(updErr);
        alert('ã‚¹ã‚³ã‚¢ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        return;
      }
    } else {
      const { error: insErr } = await db.from('scores')
        .insert({
          competition_id: currentCompId,
          player_id: player.id,
          in_score: inScore,
          out_score: outScore,
          handicap
        });
      if (insErr) {
        console.error(insErr);
        alert('ã‚¹ã‚³ã‚¢ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        return;
      }
    }

    alert('ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
  });

  scorePlayerInput.addEventListener('change', () => {
    loadScoreForCurrentPlayer();
  });

  // ==========================
  // çµæœç™ºè¡¨ç”»é¢
  // ==========================
  const resultCompSelect = document.getElementById('resultCompSelect');
  const resultPlayerSelect = document.getElementById('resultPlayerSelect');
  const resultMain = document.getElementById('resultMain');

function syncRenameOldFromName(name) {
  if (!name) return;
  renameOldInput.value = name;
}

// ãƒˆãƒƒãƒ—ç”»é¢ã®åå‰å…¥åŠ›
menuPlayerInput.addEventListener('input', () => {
  syncRenameOldFromName(menuPlayerInput.value.trim());
});

// ã‚¹ã‚³ã‚¢å…¥åŠ›ç”»é¢ã®åå‰å…¥åŠ›
scorePlayerInput.addEventListener('input', () => {
  syncRenameOldFromName(scorePlayerInput.value.trim());
});

// çµæœç™ºè¡¨ç”»é¢ã®å‚åŠ è€…é¸æŠ
resultPlayerSelect.addEventListener('change', () => {
  syncRenameOldFromName(resultPlayerSelect.value);
});

async function refreshResultCompSelect() {
  const select = resultCompSelect;
  select.innerHTML = '';

  const compsSorted = await fetchCompetitionsAll();

  if (compsSorted.length === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'ã‚³ãƒ³ãƒšãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';
    select.appendChild(opt);
    currentCompId = null;
    return;
  }
//alert("fetchCompetitionsAll()::" + compsSorted.length);
  compsSorted.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = `${c.name}ã€€${toWarekiShort(c.date)}`;
    select.appendChild(opt);
  });

  let targetId = currentCompId;

  const menuSelectedId = menuCompSelect.value;

  if (!targetId || !compsSorted.some(c => c.id === targetId)) {
    if (menuSelectedId && compsSorted.some(c => c.id === menuSelectedId)) {
      targetId = menuSelectedId;
    } else {
      targetId = compsSorted[0].id;
    }
  }

  select.value = targetId;
  currentCompId = targetId;
//alert('options:'+ [...menuCompSelect.options].map(o => o.textContent));

}

  resultCompSelect.addEventListener('change', () => {
    currentCompId = resultCompSelect.value;
    renderResultMain();
  });

  resultPlayerSelect.addEventListener('change', () => {
    currentPlayerName = resultPlayerSelect.value;
    renderResultMain();
  });

  function calcAdjustedScores(scoreRow) {
    const halfHd = scoreRow.handicap / 2;
    const inAdj = scoreRow.in_score + halfHd;
    const outAdj = scoreRow.out_score + halfHd;
    return {
      inAdj,
      outAdj,
      totalAdj: inAdj + outAdj
    };
  }

  function compareTwoPlayers(scoreA, scoreB) {
    const adjA = calcAdjustedScores(scoreA);
    const adjB = calcAdjustedScores(scoreB);

    function oneDim(a, b) {
      if (a < b) return 1;
      if (a > b) return -1;
      return 0;
    }

    const inRes = oneDim(adjA.inAdj, adjB.inAdj);
    const outRes = oneDim(adjA.outAdj, adjB.outAdj);
    const totalRes = oneDim(adjA.totalAdj, adjB.totalAdj);

    return {
      a: { in: inRes, out: outRes, total: totalRes, sum: inRes + outRes + totalRes },
      b: { in: -inRes, out: -outRes, total: -totalRes, sum: -(inRes + outRes + totalRes) }
    };
  }

  async function renderResultMain() {
    resultMain.innerHTML = '';

    if (!currentCompId) {
      resultMain.innerHTML = '<div class="msg-large">ã‚³ãƒ³ãƒšãŒã¾ã é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
      return;
    }

    const { data: comp, error: compErr } = await db.from('competitions').select('*').eq('id', currentCompId).maybeSingle();
    if (compErr || !comp) {
      resultMain.innerHTML = '<div class="msg-large">ã‚³ãƒ³ãƒšæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>';
      return;
    }

    const { data: scores, error: scoreErr } = await db.from('scores').select('*').eq('competition_id', currentCompId);
    if (scoreErr) {
      console.error(scoreErr);
      resultMain.innerHTML = '<div class="msg-large">ã‚¹ã‚³ã‚¢ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
      return;
    }
    if (!scores || scores.length === 0) {
      resultMain.innerHTML = '<div class="msg-large">ã“ã®ã‚³ãƒ³ãƒšã«ã¯ã¾ã ã‚¹ã‚³ã‚¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<span>ã‚¹ã‚³ã‚¢å…¥åŠ›ç”»é¢ã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</span></div>';
      return;
    }

    const playerIds = Array.from(new Set(scores.map(s => s.player_id)));
    const { data: players, error: playerErr } = await db.from('players').select('*').in('id', playerIds);
    if (playerErr) {
      console.error(playerErr);
      resultMain.innerHTML = '<div class="msg-large">å‚åŠ è€…æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
      return;
    }

  let prevFocusName = currentPlayerName || resultPlayerSelect.value || '';

  resultPlayerSelect.innerHTML = '';
  const ph = document.createElement('option');
  ph.value = '';
  ph.textContent = 'å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„';
  resultPlayerSelect.appendChild(ph);

  players
    .sort((a, b) => a.name.localeCompare(b.name, 'ja'))
    .forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = p.name;
      resultPlayerSelect.appendChild(opt);
    });

  if (!prevFocusName || !players.some(p => p.name === prevFocusName)) {
    // åˆå› or ç„¡åŠ¹ãªã‚‰å…ˆé ­ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
    prevFocusName = players[0]?.name || '';
  }

  resultPlayerSelect.value = prevFocusName;
  currentPlayerName = prevFocusName;

  const focusName = prevFocusName;

  const focusPlayer = players.find(p => p.name === focusName);
  if (!focusPlayer) {
    resultMain.innerHTML = `
      <div class="msg-large">
        å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
        <span>ã“ã®ã‚³ãƒ³ãƒšã«ã‚¹ã‚³ã‚¢ç™»éŒ²ã—ã¦ãªã„ãªã‚‰æ—©ãã—ãªã•ã„ã€‚</span>
      </div>`;
    return;
  }

    const scoreByPlayer = {};
    scores.forEach(s => { scoreByPlayer[s.player_id] = s; });

    const totalPts = {};
    playerIds.forEach(id => totalPts[id] = 0);

    for (let i = 0; i < playerIds.length; i++) {
      for (let j = i + 1; j < playerIds.length; j++) {
        const idA = playerIds[i];
        const idB = playerIds[j];
        const sA = scoreByPlayer[idA];
        const sB = scoreByPlayer[idB];
        if (!sA || !sB) continue;
        const result = compareTwoPlayers(sA, sB);
        totalPts[idA] += result.a.sum;
        totalPts[idB] += result.b.sum;
      }
    }

    const vsMap = {};
    playerIds.forEach(id => {
      if (id === focusPlayer.id) return;
      const sF = scoreByPlayer[focusPlayer.id];
      const sO = scoreByPlayer[id];
      if (!sF || !sO) return;
      const res = compareTwoPlayers(sF, sO);
      vsMap[id] = res.a;
    });

    const focusTotalPt = totalPts[focusPlayer.id] || 0;
    const money = focusTotalPt * comp.pt_value;

    // 1. åˆè¨ˆpt & é‡‘é¡
    const summaryCard = document.createElement('div');
    summaryCard.className = 'card';
    summaryCard.innerHTML = `
      <div class="card-header">
        <div class="card-title">
          åˆè¨ˆå‹ã¡ç‚¹ï¼†é‡‘é¡
          <span class="card-title-tag">${comp.name}ã€€${toWarekiShort(comp.date)}</span>
        </div>
      </div>
      <div class="card-body">
        <div class="pt-summary">
          ${focusPlayer.name} ã®åˆè¨ˆå‹ã¡ç‚¹ï¼š
          <span>${focusTotalPt > 0 ? '+' : ''}${focusTotalPt} pt</span>
        </div>
        <div class="pt-money ${money > 0 ? 'plus' : money < 0 ? 'minus' : 'zero'}">
          ${money > 0 ? '+' : money < 0 ? '-' : ''}${Math.abs(money).toLocaleString()} å††
        </div>
        <div class="fun-label">
          ${money > 0
            ? 'ä»Šæ—¥ã¯ã”ã¡ãã†å€™è£œã§ã™ã­ã€‚å‹ã¡è¶Šã—ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼'
            : money < 0
              ? 'ä»Šæ—¥ã¯å°‘ã—æŒã¡å‡ºã—â€¦ï¼Ÿæ¬¡å›ã®å·»ãè¿”ã—ã«æœŸå¾…ï¼'
              : 'ãƒ—ãƒ©ãƒã‚¤ã‚¼ãƒ­ã€‚è¦‹äº‹ãªãƒãƒ©ãƒ³ã‚¹ã‚²ãƒ¼ãƒ ã§ã™ã€‚'}
        </div>
      </div>
    `;
    resultMain.appendChild(summaryCard);

    // 2. å‚åŠ è€…ä¸€è¦§
    const rankingCard = document.createElement('div');
    rankingCard.className = 'card';
    const rankingRows = players
      .map(p => {
        const pt = totalPts[p.id] || 0;
        const moneyP = pt * comp.pt_value;
        return { p, pt, money: moneyP };
      })
      .sort((a, b) => b.pt - a.pt);

    let rankingHtml = `
      <div class="card-header">
        <div class="card-title">
          ã“ã®ã‚³ãƒ³ãƒšã®å…¨å‚åŠ è€…
          <span class="card-title-tag">åˆè¨ˆptã¨é‡‘é¡</span>
        </div>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="ranking-table">
            <thead>
              <tr>
                <th>é †ä½</th>
                <th>å‚åŠ è€…</th>
                <th>åˆè¨ˆpt</th>
                <th>é‡‘é¡</th>
              </tr>
            </thead>
            <tbody>
    `;

    rankingRows.forEach((r, idx) => {
      const cls = r.p.id === focusPlayer.id ? 'col-highlight' : '';
      rankingHtml += `
        <tr>
          <td class="${cls}">${idx + 1}</td>
          <td class="text-left ${cls}">${r.p.name}</td>
          <td class="${cls}">${r.pt > 0 ? '+' : r.pt < 0 ? '-' : ''}${Math.abs(r.pt)}</td>
          <td class="text-right ${cls}">${r.money > 0 ? '+' : r.money < 0 ? '-' : ''}${Math.abs(r.money).toLocaleString()} å††</td>
        </tr>
      `;
    });

    rankingHtml += `
            </tbody>
          </table>
        </div>
      </div>
    `;
    rankingCard.innerHTML = rankingHtml;
    resultMain.appendChild(rankingCard);

// 3. ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ vs å„å‚åŠ è€…ï¼ˆIN / OUT / åˆè¨ˆã‚’ãƒãƒƒã‚¸ã§æ¨ªä¸¦ã³ï¼‰
const vsCard = document.createElement('div');
vsCard.className = 'card';

let vsHtml = `
  <div class="card-header">
    <div class="card-title">
      ${focusPlayer.name} ã®å¯¾æˆ¦æˆç¸¾
      <span class="card-title-tag">IN / OUT / åˆè¨ˆ ï¼‹ ç·åˆpt</span>
    </div>
  </div>
  <div class="card-body">
`;

const opponents = players.filter(p => p.id !== focusPlayer.id && vsMap[p.id]);

if (opponents.length === 0) {
  vsHtml += '<div class="hint">æ¯”è¼ƒã§ãã‚‹ç›¸æ‰‹ãŒã„ã¾ã›ã‚“ã€‚</div>';
} else {
  const formatSum = (n) =>
    n > 0 ? `<span class="tag-plus">+${n}</span>` :
    n < 0 ? `<span class="tag-minus">${n}</span>` :
            `<span class="tag-zero">0</span>`;

  const badgeClass = (n) =>
    n > 0 ? 'pt-plus' :
    n < 0 ? 'pt-minus' : 'pt-zero';

  const badgeText = (n) =>
    n > 0 ? '+1' :
    n < 0 ? '-1' : '0';

  opponents.forEach(o => {
    const v = vsMap[o.id];
    const vsSum = v.in + v.out + v.total;

    // å‹ã¡è² ã‘ã‚¢ã‚¤ã‚³ãƒ³
    let statusIcon = 'âšª';
    let statusText = 'å¼•ãåˆ†ã‘';
    if (vsSum > 0) {
      statusIcon = 'ğŸ†';
      statusText = 'å‹ã¡';
    } else if (vsSum < 0) {
      statusIcon = 'ğŸ’§';
      statusText = 'è² ã‘';
    }

    vsHtml += `
      <div class="card" style="padding:10px;margin-bottom:10px;">
        <div class="section-title" style="margin-bottom:4px;">
          â–  ${o.name}
          <span style="margin-left:6px;font-size:0.8rem;">
            ${statusIcon} ${statusText}ï¼ˆç·åˆptï¼š${formatSum(vsSum)}ï¼‰
          </span>
        </div>
        <div class="vs-badge-row">
          <span class="vs-badge ${badgeClass(v.in)}">
            <span class="vs-badge-label">IN</span>
            <span>${badgeText(v.in)}</span>
          </span>
          <span class="vs-badge ${badgeClass(v.out)}">
            <span class="vs-badge-label">OUT</span>
            <span>${badgeText(v.out)}</span>
          </span>
          <span class="vs-badge ${badgeClass(v.total)}">
            <span class="vs-badge-label">åˆè¨ˆ</span>
            <span>${badgeText(v.total)}</span>
          </span>
        </div>
      </div>
    `;
  });
}

vsHtml += `</div>`;
vsCard.innerHTML = vsHtml;
resultMain.appendChild(vsCard);

    // 4. ã‚¹ã‚³ã‚¢ä¸€è¦§
    // 4. ã‚¹ã‚³ã‚¢ä¸€è¦§ï¼ˆå‚åŠ è€…ã‚’è¡Œã«ã—ãŸç¸¦é•·ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
    const scoreCard = document.createElement('div');
    scoreCard.className = 'card';

    // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å€¤ã‚’ã¾ã¨ã‚ã‚‹
    const valueByPlayer = {};
    players.forEach(p => {
      const s = scoreByPlayer[p.id];
      const adj = calcAdjustedScores(s);
      valueByPlayer[p.id] = {
        inScore: s.in_score,
        outScore: s.out_score,
        rawTotal: s.in_score + s.out_score,
        handicap: s.handicap,
        inAdj: adj.inAdj,
        outAdj: adj.outAdj,
        totalAdj: adj.totalAdj
      };
    });

    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåˆ—ï¼‰å®šç¾©
    const headerCols = [
      'å‚åŠ è€…',
      'IN',
      'OUT',
      'åˆè¨ˆ',
      'HD',
      'INãƒãƒ³ãƒ‡',
      'OUTãƒãƒ³ãƒ‡',
      'åˆè¨ˆãƒãƒ³ãƒ‡'
    ];

    let scoreHtml = `
      <div class="card-header">
        <div class="card-title">
          ã‚¹ã‚³ã‚¢ä¸€è¦§
          <span class="card-title-tag">ãƒãƒ³ãƒ‡è¾¼ã¿ã®ã‚¹ã‚³ã‚¢</span>
        </div>
      </div>
      <div class="card-body">
        <div class="table-container table-container-score">
          <table class="score-table">
            <thead>
              <tr>
                ${headerCols.map(h => `<th>${h}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
    `;

    // å‚åŠ è€…ã”ã¨ã«1è¡Œãšã¤ç¸¦ã«ä¸¦ã¹ã‚‹
    players.forEach(p => {
      const v = valueByPlayer[p.id];
      const isFocus = p.id === focusPlayer.id;
      const rowClass = isFocus ? 'row-highlight' : '';

      scoreHtml += `<tr class="${rowClass}">`;

      // å‚åŠ è€…åï¼ˆè‡ªåˆ†ã¯ãƒ”ãƒ«ã§å¼·èª¿ï¼‰
      scoreHtml += `<td class="name-cell">` +
        (isFocus ? `<span class="pill-current">${p.name}</span>` : p.name) +
        `</td>`;

      // IN / OUT / åˆè¨ˆ / HD / INÂ± / OUTÂ± / TOTALÂ±
      scoreHtml += `<td>${v.inScore}</td>`;
      scoreHtml += `<td>${v.outScore}</td>`;
      scoreHtml += `<td>${v.rawTotal}</td>`;
      scoreHtml += `<td>${v.handicap}</td>`;
      scoreHtml += `<td>${v.inAdj}</td>`;
      scoreHtml += `<td>${v.outAdj}</td>`;
      scoreHtml += `<td>${v.totalAdj}</td>`;

      scoreHtml += `</tr>`;
    });

    scoreHtml += `
            </tbody>
          </table>
        </div>
      </div>
    `;

    scoreCard.innerHTML = scoreHtml;
    resultMain.appendChild(scoreCard);
  }

// ===== ã‚¹ãƒãƒ›å‘ã‘ï¼šã‚¿ã‚¤ãƒˆãƒ«5é€£ã‚¿ãƒƒãƒ—ã§ç®¡ç†ãƒ„ãƒ¼ãƒ«è¡¨ç¤º/éè¡¨ç¤º =====
(function () {
  const title = document.querySelector('.title-main'); // ã€Œãƒ”ãƒ³ãƒãƒ³ãƒ‘ãƒ³ ï½èª‡ã‚Šã‹ã‚‰æ†§ã‚Œã¸ï½ã€
  const adminBox = document.getElementById('adminTools');
  if (!title || !adminBox) return;

  let tapCount = 0;
  let lastTapTime = 0;

  title.addEventListener('click', () => {
    const now = Date.now();

    // 800ms ä»¥å†…ãªã‚‰é€£ç¶šã‚¿ãƒƒãƒ—ã¨ã¿ãªã™ã€‚é–“ãŒç©ºã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆã€‚
    if (now - lastTapTime <= 800) {
      tapCount++;
    } else {
      tapCount = 1;
    }
    lastTapTime = now;

    if (tapCount >= 5) {
      // è¡¨ç¤º/éè¡¨ç¤ºã‚’ãƒˆã‚°ãƒ«
      const isHidden = adminBox.style.display === 'none' || adminBox.style.display === '';
      adminBox.style.display = isHidden ? 'block' : 'none';

      // ä»»æ„ï¼šè»½ããƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‡ºã—ãŸã‘ã‚Œã°ã‚¢ãƒ©ãƒ¼ãƒˆã‚„ãƒˆãƒ¼ã‚¹ãƒˆ
      // alert(isHidden ? 'ç®¡ç†è€…ãƒ„ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚' : 'ç®¡ç†è€…ãƒ„ãƒ¼ãƒ«ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚');

      tapCount = 0;
    }
  });
})();

  // ==========================
  // åˆæœŸåŒ–
  // ==========================
  window.addEventListener('load', async () => {
    await refreshMenuCompSelect();
    await refreshPlayerDatalist();
    // çµæœç™ºè¡¨å´ã¯ã€å®Ÿéš›ã«çµæœç”»é¢ã‚’é–‹ã„ãŸã¨ãã«ã ã‘èª­ã¿è¾¼ã‚€
    //await refreshResultCompSelect();
  });
</script>

</body>
</html>
